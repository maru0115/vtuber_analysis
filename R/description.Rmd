---
title: "個人VTuber分析レポート"
author: "まる"
date: "2024年5月27日"
output:
  html_document: 
    toc: true
    toc_float: true
    md_extentions: null
    code_folding: hide
    number_section: true
---

```{r ,include=FALSE}
# ライブラリの読み込み
library(car)
library(tidyverse)

# データの読み込み
data_livers        = read_csv("../csv/livers_info.csv", quote = '"')   %>% distinct
data_videos        = read_csv("../csv/videos_info.csv", quote = '"')   %>% distinct
data_customer      = read_csv("../csv/feature/customer.csv", quote = '"')      %>% distinct
data_gender        = read_csv("../csv/feature/gender.csv", quote = '"')        %>% distinct
data_genre         = read_csv("../csv/feature/genre.csv", quote = '"')         %>% distinct
data_model         = read_csv("../csv/feature/model.csv", quote = '"')         %>% distinct
data_collabo       = read_csv("../csv/feature/collabo.csv", quote = '"')       %>% distinct
```

# 各特徴量ごとの活動人数

## 性別
```{r}
data_gender %>% 
  pivot_longer(
    cols = -"channelId",
    names_to = "feature"
  ) %>%
  ggplot(
    aes(
      x = feature %>% reorder(value),
      y = value
    )
  ) +
  geom_bar(stat="identity") +
  xlab("性別") +
  ylab("配信者数")+
  coord_flip()
  
```

## モデル
```{r}
data_model %>% 
  pivot_longer(
    cols = -"channelId",
    names_to = "feature"
  ) %>%
  ggplot(
    aes(
      x = feature %>% reorder(value),
      y = value
    )
  ) +
  geom_bar(stat="identity") +
  xlab("モデル") +
  ylab("配信者数") +
  coord_flip()
```

## ジャンル
```{r}
data_genre %>% 
  pivot_longer(
    cols = -"channelId",
    names_to = "feature"
  ) %>%
  ggplot(
    aes(
      x = feature %>% reorder(value),
      y = value
    )
  ) +
  geom_bar(stat="identity") +
  theme(
    axis.text.x = element_text(angle = 90)
  ) +
  xlab("ジャンル") +
  ylab("配信者数")+
  coord_flip()
```

## 得意なこと
```{r}
data_customer %>% 
  pivot_longer(
    cols = -"channelId",
    names_to = "feature"
  ) %>%
  ggplot(
    aes(
      x = feature %>% reorder(value),
      y = value
    )
  ) +
  geom_bar(stat="identity") +
  theme(
    axis.text.x = element_text(angle = 90)
  ) +
  xlab("得意なこと") +
  ylab("配信者数")+
  coord_flip()
```
## コラボ希望度
```{r}
data_collabo %>% 
  ggplot(
    aes(
      x = collabo_level
    )
  ) +
  geom_bar(stat="count") +
  xlab("コラボ期待度") +
  ylab("配信者数") +
  coord_flip()
```

# 各特徴ごとのチャンネル登録者数

　
```{r}
## subscriberCountを対数変換したデータフレームを用意
data_livers_log <-
  data_livers %>% 
  filter(subscriberCount >=100) %>% 
  mutate(log_subscriberCount = subscriberCount %>% log(10)) %>% 
  select(channelId, log_subscriberCount)
```


## 性別

```{r}
### 対数変換後
data_livers_log %>% 
  inner_join(data_gender, by="channelId") %>% 
  select(-channelId) %>% 
  pivot_longer(-log_subscriberCount, names_to = "gender") %>% 
  filter(value==1) %>% 
  ggplot(
    aes(
      x = gender,
      y = log_subscriberCount
    )
  ) + 
  geom_boxplot() +
  xlab("性別") +
  ylab("チャンネル登録者")+
  coord_flip()
```
```{r ,include=FALSE}
### 対数変換前
data_livers %>% 
  select(channelId, subscriberCount) %>% 
  filter(
    subscriberCount>=100,
    subscriberCount<=10000
  ) %>% 
  inner_join(data_gender, by="channelId") %>% 
  select(-channelId) %>% 
  pivot_longer(-subscriberCount, names_to = "gender") %>% 
  filter(value==1) %>% 
  ggplot(
    aes(
      x = gender,
      y = subscriberCount
    )
  ) + 
  geom_boxplot() +
  coord_flip()
```

## チャンネル登録者に男女差はあるか

```{r}
### 対数変換後
data_test1 <-
  data_livers_log %>% 
  inner_join(data_gender, by="channelId") %>% 
  select(-channelId) %>% 
  pivot_longer(-log_subscriberCount, names_to = "gender") %>% 
  filter(value==1)

t.test(
  data_test1 %>% filter(gender=="gender_male") %>% select(log_subscriberCount),
  data_test1 %>% filter(gender=="gender_female") %>% select(log_subscriberCount),
  var.equal=F,
  paired=F
)
```
- 男女で有意な差は見られない(ただしバ美肉は不利)

```{r, include=FALSE}
### 対数変換前
data_test1 <-
  data_livers %>% 
  select(channelId, subscriberCount) %>% 
  inner_join(data_gender, by="channelId") %>% 
  select(-channelId) %>% 
  pivot_longer(-subscriberCount, names_to = "gender") %>% 
  filter(value==1)

t.test(
  data_test1 %>% filter(gender=="gender_male") %>% select(subscriberCount),
  data_test1 %>% filter(gender=="gender_female") %>% select(subscriberCount),
  var.equal=F,
  paired=F
)
```
```{r, include=FALSE}
## 得意なこと
data_livers_log %>% 
  inner_join(data_customer, by="channelId") %>% 
  select(-channelId) %>% 
  pivot_longer(-log_subscriberCount, names_to = "customer") %>% 
  filter(value==1) %>% 
  ggplot(
    aes(
      x = customer,
      y = log_subscriberCount
    )
  ) + 
  geom_boxplot() +
  theme(
    axis.text.x = element_text(angle = 90)
  ) +
  coord_flip()
```


# ジャンルのクラスタ分け

## 最適なクラスタ数を決める

### BIC
```{r}
kmeansAIC <- function(fit){
  
  m <- ncol(fit$centers)
  n <- length(fit$cluster)
  k <- nrow(fit$centers)
  D <- fit$tot.withinss
  return(data.frame(AIC = D + 2*m*k,
                    BIC = D + log(n)*m*k))
}

d <- data_genre %>% select(starts_with("genre")) 
res <- c()
for (i in 2:15){
  fit <- kmeans(d, i)
  tmp <- kmeansAIC(fit)
  res <- rbind(res, cbind(tmp, i))
}
print(res)
```

### エルボー図

```{r}
k.max <- 15
wss <- sapply(1:k.max, 
              function(k){kmeans(d, k, nstart = 50, iter.max = 15)$tot.withinss})
plot(1:k.max, wss,
     type="b", pch = 19, frame = FALSE, 
     xlab="Number of clusters K",
     ylab="Total within-clusters sum of squares")
```

### 階層クラスター分析

```{r}
result <- hclust(dist(d), method = "ward.D2")
plot(as.dendrogram(result))
rect.hclust(result, k = 5)
```

## クラスタリングの実施

```{r}
cluster = cutree(result, k=7)
len = length(cluster)

data_genre_count <-
  data_genre %>%
  pivot_longer(
    cols     = -channelId,
    names_to = "genre"
  ) %>% 
  select(-channelId) %>% 
  group_by(genre) %>% 
  summarize(count=sum(value))

data_genre %>% 
  select(starts_with("genre")) %>% 
  mutate(cluster = cluster) %>% 
  pivot_longer(
    cols = -cluster,
    names_to = "genre"
  ) %>% 
  inner_join(
    data_genre_count,
    by = "genre"
  ) %>% 
  group_by(cluster, genre) %>%
  summarize(weight=sum(value/count),n = n()) %>% 
  mutate(rate = weight) %>% 
  ggplot(
    aes(
      x = genre,
      y = rate
    )
  ) +
  geom_bar(stat="identity") +
  theme(
    axis.text.x = element_text(angle = 90)
  ) +
  facet_grid(
    cluster ~ .
  ) +
  ylim(0,1)
```

### 結果の解釈

- k = 7
  - オールジャンル
  - ゲーム特化
  - 音楽
  - お絵かき
  - アニメ
  - ギャンブル・TRPG
  - その他に特化

```{r, include=FALSE}
### ジャンルのクラスタを保存
f_genre_cluster_name <- function(cluster_num){
  if(cluster_num == 5){
    return("1:オールジャンル")
  }else if(cluster_num == 4){
    return("2:ゲーム特化")
  }else if(cluster_num == 3){
    return("3:音楽")
  }else if(cluster_num == 6){
    return("4:お絵かき")
  }else if(cluster_num == 1){
    return("5:アニメ")
  }else if(cluster_num == 7){
    return("6:ギャンブル・TRPG")
  }else{
    return("7:その他に特化")
  }
}

#data_genre %>% 
#  mutate(cluster = sapply(cluster,f_genre_cluster_name)) %>% 
#  write_csv("../csv/feature/genre_cluster.csv")
```

# ジャンルクラスタの解析

```{r, include=FALSE}
## ジャンルデータの読み込み
data_genre_cluster = read_csv("../csv/feature/genre_cluster.csv", quote = '"') %>% distinct
```

## 各ジャンルの活動者数

```{r}
data_genre_cluster %>% 
  ggplot(
    aes(
      x = cluster
    )
  ) +
  geom_bar(stat="count") +
  xlab("クラスタ") +
  ylab("配信者数") +
  coord_flip()
```

## 各ジャンルごとのチャンネル登録者数

```{r}
data_livers %>% 
  inner_join(data_genre_cluster, by="channelId") %>% 
  ggplot(
    aes(
      x = cluster,
      y = subscriberCount %>% log10
    )
  ) +
  geom_boxplot() +
  xlab("クラスタ") +
  ylab("チャンネル登録者(対数)")+
  coord_flip()
```

### 活動ジャンルはチャンネル登録者に影響を与えるか

```{r}
data_test <- 
  data_livers %>% 
  inner_join(data_genre_cluster, by="channelId")

pairwise.t.test(
  data_test$subscriberCount %>% log10,
  data_test$cluster,
  p.adj = "bonf"
)
```

- 活動ジャンルはチャンネル登録者に依らない

## 各ジャンルごとのコラボ希望度

### コラボ「5」登録率

```{r}
data_genre_cluster %>% 
  left_join(data_collabo, by="channelId") %>% 
  mutate(collabo_registration = ifelse(is.na(collabo_level)|(collabo_level<=4),0,1)) %>% 
  select(cluster, collabo_registration) %>% 
  group_by(cluster) %>% 
  summarise(collabo_registration=mean(collabo_registration)) %>% 
  ggplot(
    aes(
      x = cluster,
      y = collabo_registration
    )
  ) +
  geom_bar(stat="identity") +
  coord_flip()+
  coord_flip()
```

- ゲーム特化・お絵描きクラスタはコラボをしにくい
- ギャンブル・TRPGクラスタはコラボに寛容

# 得意なことのクラスタ分け

## 最適なクラスタ数を決める

### BIC

```{r}
kmeansAIC <- function(fit){
  
  m <- ncol(fit$centers)
  n <- length(fit$cluster)
  k <- nrow(fit$centers)
  D <- fit$tot.withinss
  return(data.frame(AIC = D + 2*m*k,
                    BIC = D + log(n)*m*k))
}

d <- data_customer %>% select(starts_with("customer")) 
res <- c()
for (i in 2:15){
  fit <- kmeans(d, i)
  tmp <- kmeansAIC(fit)
  res <- rbind(res, cbind(tmp, i))
}
print(res)
```

### 階層クラスター分析

```{r}
result <- hclust(dist(d), method = "ward.D2")
plot(as.dendrogram(result))
rect.hclust(result, k = 5)
```

## クラスタリングの実施

```{r}
cluster = cutree(result, k=6)
len = length(cluster)

data_customer_count <-
  data_customer %>%
  pivot_longer(
    cols     = -channelId,
    names_to = "customer"
  ) %>% 
  select(-channelId) %>% 
  group_by(customer) %>% 
  summarize(count=sum(value))

data_customer %>% 
  select(starts_with("customer")) %>% 
  mutate(cluster = cluster) %>% 
  pivot_longer(
    cols = -cluster,
    names_to = "customer"
  ) %>% 
  inner_join(
    data_customer_count,
    by = "customer"
  ) %>% 
  group_by(cluster, customer) %>%
  summarize(weight=sum(value/count),n = n()) %>% 
  mutate(rate = weight) %>% 
  ggplot(
    aes(
      x = customer,
      y = rate
    )
  ) +
  geom_bar(stat="identity") +
  theme(
    axis.text.x = element_text(angle = 90)
  ) +
  facet_grid(
    cluster ~ .
  ) +
  ylim(0,1)
```

### 結果の解釈

- k=6
  - 特技なし
  - ゲーム
  - お笑い・企画
  - イラスト・モデリング
  - 音楽・外国語
  - 動画編集

```{r}
### ジャンルのクラスタを保存

f_customer_cluster_name <- function(cluster_num){
  if(cluster_num == 3){
    return("1:特技なし")
  }else if(cluster_num == 6){
    return("2:ゲーム")
  }else if(cluster_num == 1){
    return("3:お笑い・企画")
  }else if(cluster_num == 2){
    return("4:イラスト・モデリング")
  }else if(cluster_num == 4){
    return("5:音楽・外国語")
  }else{
    return("6:動画編集")
  }
}

#data_customer %>% 
#  mutate(cluster = sapply(cluster,f_customer_cluster_name)) %>% 
#  write_csv("../csv/feature/customer_cluster.csv")

```

# 得意なことクラスタの解析

```{r, include=FALSE}
## 得意なことデータの読み込み
data_customer_cluster = read_csv("../csv/feature/customer_cluster.csv", quote = '"') %>% distinct
```

## 各クラスタの活動者数

```{r}
data_customer_cluster %>% 
  ggplot(
    aes(
      x = cluster
    )
  ) +
  geom_bar(stat="count") +
  xlab("クラスタ") +
  ylab("配信者数") +
  coord_flip()
```
## 各クラスタごとのチャンネル登録者数

```{r}
data_livers %>% 
  inner_join(data_customer_cluster, by="channelId") %>% 
  ggplot(
    aes(
      x = cluster,
      y = subscriberCount %>% log10
    )
  ) +
  geom_boxplot() +
  coord_flip() +
  xlab("クラスタ") +
  ylab("チャンネル登録者(対数)")
```

### 得意なことクラスタとチャンネル登録者は関連するか

```{r}
data_test <- 
  data_livers %>% 
  inner_join(data_customer_cluster, by="channelId")

pairwise.t.test(
  data_test$subscriberCount %>% log10,
  data_test$cluster,
  p.adj = "bonf"
)
```

-- 得意なこととチャンネル登録者は関連がない

# ショート動画分析

## ショート動画の投稿頻度

```{r}
data_short_count<-
  data_videos %>%
  filter(video_type == "short") %>% 
  group_by(channelId) %>% 
  summarize(n=n())

data_subscriber_and_short <-
  data_livers %>% 
  filter(subscriberCount>=100) %>% 
  left_join(data_short_count, by="channelId") %>% 
  replace_na(list(n=0)) %>% 
  mutate(n = ifelse(n>=3,"3~",n))　

data_subscriber_and_short %>% 
  ggplot(
    aes(
      x = n
    )
  ) + 
  geom_bar(stat="count") +
  xlab("投稿頻度(月あたり)") +
  ylab("配信者数")
```

## ショート投稿数とチャンネル登録者数

```{r}
data_subscriber_and_short %>% 
  ggplot(
    aes(
      x = n,
      y = subscriberCount %>% log10
    )
  )+
  geom_boxplot() +
  xlab("クラスタ") +
  ylab("チャンネル登録者(対数)")

```

### ショートの投稿頻度は登録者数に影響を与えるか？

```{r}
pairwise.t.test(
  data_subscriber_and_short$subscriberCount %>% log10,
  data_subscriber_and_short$n,
  p.adj = "bonf"
)
```
- ショート動画を上げる頻度とチャンネル登録者数は関係ない

## バズったショートを定義する

```{r}
data_short_buzz <-
  data_videos %>% 
  filter(video_type == "short") %>% 
  inner_join(
    data_livers %>% select(channelId, subscriberCount),
    by="channelId"
  ) %>% 
  select(channelId, title, subscriberCount, viewCount) %>% 
  filter(viewCount>0) %>% 
  mutate(
    log_subscriberCount = subscriberCount %>% log10,
    log_viewCount       = viewCount %>% log10
  )

# 回帰
fit <- lm(log_viewCount ~ log_subscriberCount,data = data_short_buzz)

# 90%予測区間を追加
data_short_buzz <-
  data_short_buzz %>% 
  cbind(predict(fit, interval = "prediction", level=0.90))

# バズりshortの定義を可視化
data_short_buzz %>% 
  ggplot(
    aes(
      x = log_subscriberCount,
      y = log_viewCount
    )
  ) +
  geom_point() +
  geom_smooth(
    method = "lm",
    se = FALSE
  ) +
  geom_ribbon(
    aes(
      ymin = lwr, 
      ymax = upr
    ),
    alpha = 0.2,
    fill = 'blue'
  )
```

```{r}
data_short_buzz_summary <-
  data_short_buzz %>% 
  mutate(buzz_count = ifelse(log_viewCount>upr,1,0)) %>% 
  group_by(channelId) %>% 
  summarize(buzz_count=sum(buzz_count))

data_livers_with_buzz <-
  data_livers %>% 
  inner_join(data_short_buzz_summary, by="channelId") %>% 
  mutate(buzz_flag = ifelse(buzz_count>0,1,0))

# csvの保存
# data_livers_with_buzz %>% write_csv("../csv/livers_with_buzz.csv")
```


### バズったShortがあるかどうかと、チャンネル登録者の関係

```{r}
data_livers_with_buzz %>% 
  ggplot(
    aes(
      x = buzz_flag %>% as.character,
      y = subscriberCount %>% log10
    )
  )+
  geom_boxplot() +
  xlab("バズった動画の有無") +
  ylab("チャンネル登録者(対数)")
```

### 有意性の検定

```{r}

data_test2 <-
  data_livers_with_buzz %>% 
  inner_join(data_gender, by="channelId") %>% 
  select(-channelId, -title, -publishedAt) %>% 
  pivot_longer(-subscriberCount, names_to = "gender") %>% 
  filter(value==1)

t.test(
  data_livers_with_buzz %>% filter(buzz_flag==0) %>% select(subscriberCount) %>% log10,
  data_livers_with_buzz %>% filter(buzz_flag==1) %>% select(subscriberCount) %>% log10,
  var.equal=F,
  paired=F
)
```
- バズったShortの有無とチャンネル登録者の間に関連なし
